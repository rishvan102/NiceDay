<!DOCTYPE html>
<html lang="en" data-basepath="NiceDay">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>NiceDay PDF Jar — Fast PDF tools in your browser ☀️</title>
  <meta name="google-site-verification" content="9e8DEhMn3VK8Ot9lYxzBzapmNl3sSZGe1W9PtxMTX5c" />
  <meta name="description" content="Create, merge, split, reorder, rotate, number, watermark, compress, export images, redact, and more — all locally in your browser. No upload needed." />
  <link rel="canonical" href="https://example.com/" />
  <meta name="theme-color" content="#ffb703" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#141414" media="(prefers-color-scheme: dark)">

  <!-- Icons/manifest (GitHub Pages subpath) -->
  <link rel="icon" href="/NiceDay/icons/icon-192.png" />
  <link rel="apple-touch-icon" href="/NiceDay/icons/icon-192.png" />
  <link rel="manifest" href="/NiceDay/manifest.webmanifest" />

  <!-- Preconnects -->
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="preconnect" href="https://unpkg.com" crossorigin />

  <!-- Tailwind build (your CSS) -->
  <link rel="stylesheet" href="dist/styles.css" />

  <style>
    :root{ --brand:#ffb703;--brand-2:#fb8500; --bg-a:#fff7ea;--bg-b:#fffdf7; --ink:#111827;--muted:#6b7280; }
    html,body{height:100%}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 20% -10%, var(--bg-a), transparent),
        radial-gradient(1200px 600px at 80% 110%, var(--bg-a), transparent),
        linear-gradient(180deg, var(--bg-b), #ffffff);
      min-height:100dvh; display:flex; flex-direction:column;
    }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* Header / hero */
    header{max-width:72rem;margin-inline:auto;padding:2rem 1rem 1rem}
    .home-hero{margin-top:1.25rem;background:#fff;border:1px solid #f3f4f6;border-radius:1.25rem;padding:1.25rem 1rem}
    @media(min-width:768px){.home-hero{padding:2rem}}
    .cta-primary{display:inline-block;margin-top:1rem;padding:.75rem 1.25rem;background:#2563eb;color:#fff;border-radius:.75rem;font-weight:600}
    .cta-primary:hover{background:#1e40af}

    /* Quick grid */
    .home-grid{display:grid;gap:1rem;margin-top:1rem;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .home-card{background:#fff;border:1px solid #edf0f5;border-radius:12px;padding:16px;text-align:left;transition:transform .15s, box-shadow .15s, border-color .15s}
    .home-card:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.07);border-color:#e5e7eb}
    .home-card h3{font-weight:600;font-size:1rem;margin-bottom:.25rem;display:flex;align-items:center;gap:.5rem}
    .home-card p{font-size:.875rem;color:#6b7280}

    /* Tabs + Search */
    .controls-wrap{max-width:72rem;margin:1rem auto 0;padding:0 1rem}
    #tabs{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem}
    .tab{border:1px solid #fde68a;background:#fffbea;padding:.5rem .85rem;border-radius:999px;white-space:nowrap}
    .tab.active{background:#ffedd5;border-color:#fdba74}
    .search-row{display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
    .search-row .tip{font-size:.8rem;color:#6b7280}
    .search-box{position:relative;flex:1;min-width:260px;max-width:720px}
    .search-box input{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:.6rem 1rem .6rem 2.2rem;background:#fff}
    .search-box span{position:absolute;left:.75rem;top:.55rem;color:#9ca3af}

    /* Main/tools */
    #main{max-width:72rem;margin:0 auto;padding:1rem 1rem 2rem;width:100%}
    .grid-tools{display:grid;gap:1.25rem;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));align-items:stretch}
    .grid-tools.edit-grid{grid-template-columns:repeat(auto-fill,minmax(300px,1fr))}
    @media (min-width:1024px){.grid-tools.edit-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .tool-card{
      display:flex;flex-direction:column;justify-content:flex-start;
      background:rgba(255,255,255,.9);backdrop-filter:blur(6px);
      border-radius:1rem;border:1px solid #f3f4f6;padding:1.25rem;transition:transform .15s ease, box-shadow .15s ease;
      min-height:360px;scroll-margin-top:140px
    }
    .tool-card:hover{transform:translateY(-2px);box-shadow:0 12px 30px rgba(0,0,0,.08)}
    .tool-card.compact{min-height:260px}
    .tool-card > *:last-child{margin-top:auto}
    .tool-card button{margin-top:auto;min-height:2.75rem}
    .tool-card [id$="Status"]{min-height:1.25rem;margin-top:.5rem;font-size:.75rem;color:#6b7280}
    .tool-card input[type="text"],.tool-card input[type="number"],.tool-card input[type="file"],.tool-card select,.tool-card textarea{min-height:2.5rem;font-size:.9rem}

    /* Pulse highlight */
    @keyframes nd-pulse{0%{box-shadow:0 0 0 0 rgba(37,99,235,.5)}100%{box-shadow:0 0 0 16px rgba(37,99,235,0)}}
    .pulse{animation: nd-pulse 1.1s ease-out 0s 2;outline:2px solid #2563eb;outline-offset:2px}

    /* Redact canvas */
    #redactStage{width:100%;max-height:60vh;border-radius:12px;border:1px solid #e5e7eb;object-fit:contain;background:#fff}

    /* Footer */
    footer{margin-top:auto;padding:1.5rem 1rem;border-top:1px solid #f3f4f6;color:#6b7280;font-size:.9rem}
    footer .inner{max-width:72rem;margin:0 auto;display:flex;flex-direction:column;gap:.75rem}
    @media(min-width:768px){footer .inner{flex-direction:row;justify-content:space-between;align-items:center}}
    footer a{text-decoration:underline;text-underline-offset:2px}

    /* ======= Camera overlay (portrait-first) ======= */
    .cam-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;z-index:60}
    .cam-overlay.show{display:block}
    .cam-sheet{position:absolute;inset:0;display:flex;flex-direction:column;background:#000}
    .cam-bar{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:rgba(0,0,0,.5);color:#fff}
    .cam-title{font-weight:600}
    .cam-actions{display:flex;gap:.5rem}
    .cam-btn{background:#1f2937;color:#fff;border:1px solid #374151;border-radius:.5rem;padding:.4rem .65rem}
    .cam-btn.cam-danger{background:#7f1d1d;border-color:#991b1b}

    /* live stage */
    .cam-stage{flex:1;display:grid;place-items:center;background:#000;overflow:hidden}
    #scanVideo{width:100%;height:100%;object-fit:cover;background:#000}
    @media(min-width:640px){ #scanVideo{object-fit:contain} }

    .cam-controls{padding:.75rem;display:flex;justify-content:center;gap:1rem;background:rgba(0,0,0,.55)}
    .cam-cta{background:#10b981;color:#fff;border:0;border-radius:.75rem;padding:.8rem 1.4rem;font-weight:700}

    /* In-overlay thumbnail tray */
    .cam-tray{display:flex;gap:.5rem;overflow-x:auto;padding:.5rem;background:rgba(0,0,0,.45)}
    .cam-thumb{position:relative;border:1px solid #374151;border-radius:.45rem;min-width:96px;max-width:96px;overflow:hidden;background:#111}
    .cam-thumb img{display:block;width:100%;height:100%;object-fit:cover}
    .cam-thumb .x{position:absolute;top:4px;right:4px;background:#000a;color:#fff;border:1px solid #fff2;border-radius:.4rem;font-size:.75rem;padding:.05rem .35rem}

    /* Thumbnails in the tool card */
    #scanThumbs .thumb{position:relative;border:1px solid #e5e7eb;border-radius:.5rem;overflow:hidden;background:#fff}
    #scanThumbs img{display:block;width:100%;height:auto}
    .thumb .x{position:absolute;top:6px;right:6px;background:#111;color:#fff;font-size:.75rem;border-radius:.4rem;padding:.15rem .35rem}
    .thumb .handle{position:absolute;left:6px;top:6px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:.4rem;font-size:.75rem;padding:.15rem .35rem;cursor:grab}

    /* Optional toast (kept for fallback) */
    .nd-toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%) scale(.96);background:#111;color:#fff;border-radius:14px;padding:.85rem 1rem;z-index:70;opacity:0;pointer-events:none;border:1px solid #2d2d2d;box-shadow:0 10px 30px rgba(0,0,0,.25);max-width:min(92vw,540px);text-align:center}
    .nd-toast.show{opacity:1;pointer-events:auto;transform:translateX(-50%) scale(1);transition:.18s ease}

    /* ===== Celebration Modal ===== */
    .celebrate-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:80}
    .celebrate-overlay.show{display:block}
    .celebrate-modal{position:fixed;inset:0;display:grid;place-items:center;z-index:81}
    .celebrate-card{
      width:min(92vw,420px);aspect-ratio:1/1;
      background:linear-gradient(135deg,#fff,#fff8ec);
      border:1px solid #ffe1b3;border-radius:24px;box-shadow:0 20px 50px rgba(0,0,0,.18);
      transform:scale(.96);opacity:0;transition:transform .22s ease,opacity .22s ease;
      display:flex;flex-direction:column;align-items:center;justify-content:space-between;padding:22px;text-align:center;
    }
    .celebrate-overlay.show + .celebrate-modal .celebrate-card{transform:scale(1);opacity:1}
    .ce-badge{font-size:12px;padding:6px 10px;border-radius:999px;color:#0b3b2d;background:linear-gradient(135deg,#d7ffe9,#b9f3d0);border:1px solid #7bdba9}
    .ce-cta{background:#111;color:#fff;padding:10px 14px;border-radius:12px;border:0;cursor:pointer}
    .ce-cta:hover{filter:brightness(1.05)}
    .ce-confetti{position:absolute;inset:0;pointer-events:none;overflow:hidden;border-radius:24px}
    .ce-piece{position:absolute;width:10px;height:14px;border-radius:2px;opacity:0;transform:translate(-50%,-50%) scale(.2) rotate(0deg)}
    @keyframes ce-burst{0%{opacity:1;transform:translate(-50%,-50%) scale(1) rotate(0deg)}100%{opacity:0;transform:translate(var(--dx),var(--dy)) scale(1) rotate(var(--rot))}}
  </style>

  <!-- Subpath helper -->
  <script>
    (function(){
      const baseAttr = document.documentElement.getAttribute('data-basepath') || "";
      const base = window.__ND_BASE_PATH__ || baseAttr || "";
      window.__ndPath__ = (p) =>
        (base ? ("/" + base.replace(/^\/|\/$/g,"") + "/" + p.replace(/^\/+/,""))
              : "/" + p.replace(/^\/+/,""));
    })();
  </script>
</head>
<body>
  <a class="sr-only" href="#main">Skip to content</a>

  <!-- Header -->
  <header>
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl flex items-center justify-center text-white font-bold text-xl" style="background:linear-gradient(135deg,var(--brand),var(--brand-2))" aria-hidden="true">📄</div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">NiceDay PDF Jar</h1>
          <p class="text-sm text-gray-600 -mt-1">by <span class="font-semibold">Nice Day</span> — docs & PDFs with sunshine ☀️</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="px-3 py-1 rounded-full text-sm" style="background:linear-gradient(90deg,#ffd166,var(--brand))">Always Positive Vibes</span>
        <button id="installBtn" class="hidden px-3 py-1 rounded-full text-sm border border-amber-300 hover:bg-amber-50">Install App</button>
      </div>
    </div>

    <!-- Hero -->
    <div class="home-hero">
      <h2 class="text-2xl md:text-4xl font-bold">Make beautiful things with your documents — and leave with a smile.</h2>
      <p class="text-gray-600 mt-2 md:text-lg">A simplified tool for working with PDFs and other document files.</p>
      <a href="#quick" class="cta-primary">Try it now</a>

      <!-- Tabs + Search -->
      <div class="controls-wrap">
        <div id="tabs">
          <button class="tab active" data-tab="docs" aria-pressed="true">Docs</button>
          <button class="tab" data-tab="convert" aria-pressed="false">Convert</button>
          <button class="tab" data-tab="organize" aria-pressed="false">Organize</button>
          <button class="tab" data-tab="edit" aria-pressed="false">Edit</button>
          <button class="tab" data-tab="secure" aria-pressed="false">Secure</button>
        </div>

        <div class="search-row">
          <div class="search-box">
            <label for="toolSearch" class="sr-only">Search tools</label>
            <input id="toolSearch" type="search" inputmode="search" placeholder="Search tools (e.g., write, merge, rotate, watermark)…" />
            <span aria-hidden="true">🔎</span>
          </div>
          <div class="tip">Tip: type to quickly filter tools</div>
        </div>
      </div>

      <!-- Quick grid -->
      <div id="quick" class="home-grid">
        <button class="home-card" data-open="docs"><h3>📝 Write</h3><p>Convert notes to elegantly formatted PDFs</p></button>
        <button class="home-card" data-open="docs"><h3>📄 Convert</h3><p>Upload text/Markdown or DOCX to PDF</p></button>
        <button class="home-card" data-open="convert" data-anchor="scan"><h3>📷 Scan</h3><p>Scan pages using your camera into PDF</p></button>
        <button class="home-card" data-open="convert" data-anchor="images"><h3>🖼️ Images</h3><p>Convert images to PDFs</p></button>
        <button class="home-card" data-open="convert" data-anchor="export"><h3>🔁 Export</h3><p>Turn PDF pages into images</p></button>
        <button class="home-card" data-open="convert" data-anchor="compress"><h3>🪄 Compress</h3><p>Rasterize pages to reduce PDFs</p></button>
        <button class="home-card" data-open="organize"><h3>➕ Merge</h3><p>Combine multiple PDFs into one</p></button>
        <button class="home-card" data-open="organize" data-anchor="split"><h3>✂️ Split</h3><p>Split PDFs into sections</p></button>
        <button class="home-card" data-open="edit"><h3>✏️ Edit</h3><p>Insert, duplicate, rotate, crop, sign</p></button>
      </div>
    </div>
  </header>

  <!-- Tools -->
  <div id="main">
    <!-- DOCS -->
    <section class="tabpanel" data-tabpanel="docs" role="region" aria-label="Docs">
      <div class="grid-tools">
        <div class="tool-card md:col-span-2" data-tags="docs note write text pdf" id="tool-write">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">📝</span> Write a Note → PDF</h3>
          <p class="text-sm text-gray-600 mb-2">Type your note. We’ll wrap it nicely across A4 pages.</p>
          <label for="noteInput" class="sr-only">Note content</label>
          <textarea id="noteInput" rows="10" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Type your note here…"></textarea>
          <div class="flex gap-2 mt-3">
            <input id="noteTitle" class="border rounded-lg px-3 py-2 text-sm flex-1" placeholder="Title (optional)" aria-label="Note title (optional)" />
            <button id="noteBtn" class="px-4 py-2 bg-black text-white rounded-lg">Create PDF</button>
          </div>
          <p id="noteStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="docs text markdown md files pdf" id="tool-convert-text">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">📄</span> Text/Markdown files → PDF</h3>
          <p class="text-sm text-gray-600 mb-2">Upload .txt / .md files; each becomes a section.</p>
          <input id="txtFilesInput" type="file" accept=".txt,.md,text/plain,text/markdown" multiple class="block w-full text-sm" aria-label="Choose text or markdown files"/>
          <button id="txtFilesBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Create PDF</button>
          <p id="txtFilesStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card opacity-60" data-tags="docs docx word convert" id="tool-docx">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🧩</span> DOCX → PDF</h3>
          <p class="text-sm text-gray-600 mb-2">Convert Word to PDF. (Needs extra library/server)</p>
          <button class="w-full border rounded-lg py-2 cursor-not-allowed" aria-disabled="true">In progress</button>
        </div>
      </div>
    </section>

    <!-- CONVERT -->
    <section class="tabpanel hidden" data-tabpanel="convert" role="region" aria-label="Convert">
      <div class="grid-tools">
        <!-- Scan to PDF (Camera) -->
        <div class="tool-card rounded-2xl border p-5 md:col-span-2" id="tool-scan" data-tags="convert scan camera">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">📷</span> Scan to PDF (Camera)</h3>
          <p class="text-sm text-gray-600 mb-2">Capture pages from your camera, arrange them, then export to PDF.</p>

          <div class="grid grid-cols-2 gap-2">
            <button id="scanOpen" class="px-3 py-2 border rounded-lg">Open Camera</button>
            <button id="scanExport" class="px-3 py-2 bg-black text-white rounded-lg">Export PDF</button>
          </div>

          <div id="scanThumbs" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 mt-3" aria-live="polite"></div>
          <p id="scanStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <!-- Fullscreen Camera Modal -->
        <div id="camOverlay" class="cam-overlay" aria-hidden="true">
          <div class="cam-sheet" role="dialog" aria-modal="true" aria-labelledby="camTitle">
            <div class="cam-bar">
              <div class="cam-title" id="camTitle">Camera</div>
              <div class="cam-actions">
                <button id="camFlip" class="cam-btn" title="Switch camera">🔄</button>
                <button id="camClose" class="cam-btn cam-danger" title="Close">✕</button>
              </div>
            </div>

            <div class="cam-stage">
              <video id="scanVideo" autoplay playsinline></video>
            </div>

            <!-- In-overlay thumbnail tray -->
            <div id="camTray" class="cam-tray" aria-live="polite"></div>

            <div class="cam-controls">
              <button id="scanSnap" class="cam-cta">Take Snapshot</button>
            </div>
          </div>
        </div>

        <div class="tool-card" data-tags="convert images" id="tool-images">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🖼️</span> Images → PDF</h3>
          <p class="text-sm text-gray-600 mb-2">Turn JPG/PNG images into a single PDF.</p>
          <input id="imgInput" type="file" accept="image/*" multiple class="block w-full text-sm" aria-label="Choose images"/>
          <button id="imgBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Create PDF & Download</button>
          <p id="imgStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="convert pdf images export png jpg" id="tool-export">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🔁</span> PDF → Images (ZIP)</h3>
          <p class="text-sm text-gray-600 mb-2">Export each page as PNG or JPG. We’ll bundle them into a .zip.</p>
          <input id="pdf2imgInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF" />
          <div class="grid grid-cols-2 gap-2">
            <select id="pdf2imgFormat" class="border rounded-lg px-3 py-2 text-sm"><option value="png">PNG</option><option value="jpeg">JPG</option></select>
            <select id="pdf2imgScale" class="border rounded-lg px-3 py-2 text-sm"><option value="1">Scale 1x</option><option value="1.5">Scale 1.5x</option><option value="2">Scale 2x</option></select>
          </div>
          <button id="pdf2imgBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Export Images (ZIP)</button>
          <p id="pdf2imgStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="convert compress reduce size optimize" id="tool-compress">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🪄</span> Compress PDF</h3>
          <p class="text-sm text-gray-600 mb-2">Rasterizes pages to JPEG. Lower quality/scale = smaller file.</p>
          <input id="cmpInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF" />
          <div class="grid grid-cols-3 gap-2">
            <select id="cmpScale" class="border rounded-lg px-3 py-2 text-sm">
              <option value="1">Scale 1.0</option><option value="0.8">0.8</option><option value="0.6">0.6</option><option value="0.5">0.5</option>
            </select>
            <input id="cmpQuality" type="number" min="0.3" max="0.95" step="0.05" value="0.8" class="border rounded-lg px-3 py-2 text-sm" />
            <select id="cmpFormat" class="border rounded-lg px-3 py-2 text-sm"><option value="jpeg">JPG</option><option value="png">PNG (bigger)</option></select>
          </div>
          <button id="cmpBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Compress & Download</button>
          <p id="cmpStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>
      </div>
    </section>

    <!-- ORGANIZE -->
    <section class="tabpanel hidden" data-tabpanel="organize" role="region" aria-label="Organize">
      <div class="grid-tools">
        <div class="tool-card" data-tags="organize merge combine" id="tool-merge">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">➕</span> Merge PDFs</h3>
          <p class="text-sm text-gray-600 mb-3">Combine multiple PDFs into one.</p>
          <input id="mergeInput" type="file" multiple accept="application/pdf" class="block w-full text-sm" aria-label="Choose PDFs to merge" />
          <button id="mergeBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Merge & Download</button>
          <p id="mergeStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="organize split extract" id="tool-split">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">✂️</span> Split PDF</h3>
          <p class="text-sm text-gray-600 mb-2">Ranges (e.g., 1-3,5,9-10). Each range = separate file.</p>
          <input id="splitInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to split" />
          <input id="splitRanges" placeholder="1-3,5" class="w-full border rounded-lg px-3 py-2 text-sm" aria-label="Page ranges to split"/>
          <button id="splitBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Split & Download</button>
          <p id="splitStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="organize insert blank page" id="tool-blank">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🧾</span> Insert Blank Pages</h3>
          <p class="text-sm text-gray-600 mb-2">Insert N blank A4 pages before/after a page number.</p>
          <input id="blankInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF" />
          <div class="grid grid-cols-3 gap-2">
            <input id="blankAt" type="number" min="1" placeholder="At page" class="border rounded-lg px-3 py-2 text-sm" />
            <select id="blankWhere" class="border rounded-lg px-3 py-2 text-sm"><option value="before">Before</option><option value="after">After</option></select>
            <input id="blankCount" type="number" min="1" value="1" class="border rounded-lg px-3 py-2 text-sm" />
          </div>
          <button id="blankBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Insert & Download</button>
          <p id="blankStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card md:col-span-2" data-tags="organize reorder arrange" id="tool-reorder">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">📑</span> Reorder Pages (Drag & Drop)</h3>
          <p class="text-sm text-gray-600 mb-2">Upload a PDF, then drag thumbnails to reorder.</p>
          <input id="reorderDnDInput" type="file" accept="application/pdf" class="block w-full text-sm mb-3" aria-label="Choose PDF to reorder" />
          <div id="reorderGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3 min-h-[120px]" aria-live="polite"></div>
          <div class="flex gap-2 mt-3">
            <button id="reorderReset" class="px-3 py-2 border rounded-lg">Reset Order</button>
            <button id="reorderExport" class="px-3 py-2 bg-black text-white rounded-lg">Export Reordered PDF</button>
          </div>
          <p id="reorderDnDStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="organize duplicate copy pages" id="tool-duplicate">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">📚</span> Duplicate Pages</h3>
          <p class="text-sm text-gray-600 mb-2">Ranges to duplicate (e.g., 2,4-5). Duplicates will be appended.</p>
          <input id="dupInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF" />
          <input id="dupRanges" placeholder="2,4-5" class="w-full border rounded-lg px-3 py-2 text-sm" aria-label="Pages to duplicate"/>
          <button id="dupBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Duplicate & Download</button>
          <p id="dupStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>
      </div>
    </section>

    <!-- EDIT -->
    <section class="tabpanel hidden" data-tabpanel="edit" role="region" aria-label="Edit">
      <div class="grid-tools edit-grid">
        <div class="tool-card" data-tags="edit rotate orientation" id="tool-rotate">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🔄</span> Rotate Pages</h3>
          <p class="text-sm text-gray-600 mb-2">Ranges + angle (90/180/270).</p>
          <input id="rotInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to rotate" />
          <div class="flex gap-2">
            <input id="rotRanges" placeholder="1-3,7" class="w-full border rounded-lg px-3 py-2 text-sm" aria-label="Page ranges to rotate"/>
            <input id="rotAngle" type="number" placeholder="90" value="90" class="w-24 border rounded-lg px-3 py-2 text-sm" aria-label="Rotation angle"/>
          </div>
          <button id="rotBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Rotate & Download</button>
          <p id="rotStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="edit delete remove" id="tool-delete">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🧹</span> Delete Pages</h3>
          <p class="text-sm text-gray-600 mb-2">Pages to remove (e.g., 2,4-6).</p>
          <input id="delInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to delete pages from" />
          <input id="delList" placeholder="2,4-6" class="w-full border rounded-lg px-3 py-2 text-sm" aria-label="Pages to delete"/>
          <button id="delBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Delete & Download</button>
          <p id="delStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="edit extract keep" id="tool-extract">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">📤</span> Extract Pages</h3>
          <p class="text-sm text-gray-600 mb-2">Keep only these pages (e.g., 1-3,9).</p>
          <input id="extInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to extract pages" />
          <input id="extList" placeholder="1-3,9" class="w-full border rounded-lg px-3 py-2 text-sm" aria-label="Pages to keep"/>
          <button id="extBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Extract & Download</button>
          <p id="extStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="edit page numbers footer header" id="tool-numbers">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🔢</span> Add Page Numbers</h3>
          <p class="text-sm text-gray-600 mb-2">Position + margin.</p>
          <input id="numInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to number" />
          <div class="grid grid-cols-2 gap-2">
            <select id="numPos" class="border rounded-lg px-3 py-2 text-sm">
              <option value="br">Bottom Right</option><option value="bc">Bottom Center</option>
              <option value="bl">Bottom Left</option><option value="tr">Top Right</option>
              <option value="tc">Top Center</option><option value="tl">Top Left</option>
            </select>
            <input id="numMargin" type="number" value="24" class="border rounded-lg px-3 py-2 text-sm" />
          </div>
          <button id="numBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Number & Download</button>
          <p id="numStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card" data-tags="edit watermark branding" id="tool-watermark">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">💧</span> Add Watermark</h3>
          <p class="text-sm text-gray-600 mb-2">Large diagonal text watermark.</p>
          <input id="wmInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to watermark" />
          <input id="wmText" placeholder="CONFIDENTIAL" class="w-full border rounded-lg px-3 py-2 text-sm mb-2" aria-label="Watermark text"/>
          <div class="grid grid-cols-3 gap-2">
            <input id="wmSize" type="number" value="64" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="wmAngle" type="number" value="45" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="wmAlpha" type="number" value="0.15" step="0.05" class="border rounded-lg px-3 py-2 text-sm" />
          </div>
          <p class="text-xs text-gray-500 mt-1">Size | Angle° | Opacity (0-1)</p>
          <button id="wmBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Watermark & Download</button>
          <p id="wmStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card compact" data-tags="edit crop margins" id="tool-crop">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">✂️</span> Crop Margins</h3>
          <p class="text-sm text-gray-600 mb-2">Set margins to remove (points). Applies to all pages.</p>
          <input id="cropInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF" />
          <div class="grid grid-cols-4 gap-2">
            <input id="cropTop" type="number" min="0" placeholder="Top" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="cropRight" type="number" min="0" placeholder="Right" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="cropBottom" type="number" min="0" placeholder="Bottom" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="cropLeft" type="number" min="0" placeholder="Left" class="border rounded-lg px-3 py-2 text-sm" />
          </div>
          <button id="cropBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Crop & Download</button>
          <p id="cropStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card compact" data-tags="edit text stamp label" id="tool-stamp">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🏷️</span> Add Text Stamp</h3>
          <p class="text-sm text-gray-600 mb-2">Add a small label on every page.</p>
          <input id="stampInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF" />
          <input id="stampText" placeholder="Reviewed ✓" class="w-full border rounded-lg px-3 py-2 text-sm mb-2" aria-label="Stamp text"/>
          <div class="grid grid-cols-3 gap-2">
            <select id="stampPos" class="border rounded-lg px-3 py-2 text-sm">
              <option value="br">Bottom Right</option><option value="bc">Bottom Center</option>
              <option value="bl">Bottom Left</option><option value="tr">Top Right</option>
              <option value="tc">Top Center</option><option value="tl">Top Left</option>
            </select>
            <input id="stampSize" type="number" value="10" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="stampMargin" type="number" value="16" class="border rounded-lg px-3 py-2 text-sm" />
          </div>
          <button id="stampBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Stamp & Download</button>
          <p id="stampStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card compact" data-tags="edit sign signature image" id="tool-sign">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">✍️</span> Add Signature (PNG)</h3>
          <p class="text-sm text-gray-600 mb-3">Place a transparent PNG signature on all pages (bottom-right by default).</p>
          <input id="signPdfInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to sign" />
          <input id="signImgInput" type="file" accept="image/png,image/jpeg" class="block w-full text-sm mb-2" aria-label="Choose signature image" />
          <div class="grid grid-cols-3 gap-2">
            <input id="signWidth" type="number" value="120" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="signMarginX" type="number" value="24" class="border rounded-lg px-3 py-2 text-sm" />
            <input id="signMarginY" type="number" value="24" class="border rounded-lg px-3 py-2 text-sm" />
          </div>
          <p class="text-xs text-gray-500 mt-1">Width(px) • Margin X/Y (from bottom-right).</p>
          <button id="signBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Sign & Download</button>
          <p id="signStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>
      </div>
    </section>

    <!-- SECURE -->
    <section class="tabpanel hidden" data-tabpanel="secure" role="region" aria-label="Secure">
      <div class="grid-tools">
        <div class="tool-card" data-tags="secure metadata privacy remove info" id="tool-metadata">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🧼</span> Strip Metadata</h3>
          <p class="text-sm text-gray-600 mb-2">Make a clean copy without document metadata.</p>
          <input id="metaInput" type="file" accept="application/pdf" class="block w-full text-sm mb-2" aria-label="Choose PDF to clean" />
          <button id="metaBtn" class="mt-3 w-full bg-black text-white rounded-lg py-2">Create Clean Copy</button>
          <p id="metaStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>

        <div class="tool-card md:col-span-2" data-tags="secure redact hide black box" id="tool-redact">
          <h3 class="tool-title font-semibold text-lg mb-2"><span class="emoji" aria-hidden="true">🕶️</span> Redact (Draw Boxes)</h3>
          <p class="text-sm text-gray-600 mb-2">Load a PDF, draw black boxes over sensitive areas, then apply.</p>
          <input id="redactInput" type="file" accept="application/pdf" class="block w-full text-sm mb-3" aria-label="Choose PDF to redact" />
          <div class="flex items-center justify-between mb-2 text-sm text-gray-600">
            <span id="redInfo">No file loaded</span>
            <div class="flex gap-2">
              <button id="redPrev" class="px-3 py-1 border rounded-lg">Prev</button>
              <button id="redNext" class="px-3 py-1 border rounded-lg">Next</button>
              <button id="redClear" class="px-3 py-1 border rounded-lg">Clear Page</button>
            </div>
          </div>
          <canvas id="redactStage" class="w-full max-w-full" width="600" height="800" aria-label="Redaction canvas"></canvas>
          <div class="flex gap-2 mt-3">
            <button id="redApply" class="px-3 py-2 bg-black text-white rounded-lg flex-1">Apply Redactions & Download</button>
          </div>
          <p id="redStatus" class="text-xs text-gray-500 mt-2" aria-live="polite"></p>
        </div>
      </div>
    </section>
  </div>

  <footer>
    <div class="inner">
      <div>© <span id="yr"></span> Nice Day. All rights reserved.</div>
      <nav class="flex gap-4">
        <a href="#" aria-disabled="true">Privacy</a>
        <a href="#" aria-disabled="true">Terms</a>
        <a href="#" aria-disabled="true">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- Celebration Modal -->
  <div id="ceOverlay" class="celebrate-overlay" aria-hidden="true"></div>
  <div id="ceModal" class="celebrate-modal" role="dialog" aria-modal="true" aria-labelledby="ceTitle" aria-describedby="ceMsg" style="visibility:hidden;">
    <div class="celebrate-card">
      <div class="ce-badge">Nice Day Boost</div>
      <div class="ce-confetti" id="ceFx" aria-hidden="true"></div>
      <div>
        <h3 id="ceTitle" class="text-lg font-semibold">Great job!</h3>
        <p id="ceMsg" class="text-sm text-gray-700 mt-1">You did it. Keep the momentum going.</p>
      </div>
      <button id="ceClose" class="ce-cta">Thanks!</button>
    </div>
  </div>

  <!-- Libs -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js" crossorigin="anonymous"></script>
  <!-- Polyfill for async/generators used by app.js/fontkit -->
  <script defer src="https://cdn.jsdelivr.net/npm/regenerator-runtime@0.13.9/runtime.min.js" crossorigin="anonymous"></script>
  <!-- Your app code -->
  <script src="app.js" defer></script>

  <!-- Celebration controller (defines window.ndCelebrate) -->
  <script>
    (function(){
      const overlay = document.getElementById('ceOverlay');
      const modal   = document.getElementById('ceModal');
      const closeBtn= document.getElementById('ceClose');
      const fxBox   = document.getElementById('ceFx');
      const QUOTES = [
        "Small steps make big things.",
        "Done is better than perfect.",
        "Every page is progress.",
        "You’re closer than you think.",
        "Tiny wins add up fast.",
        "Momentum loves action.",
        "Keep going — you’ve got this!"
      ];
      function rand(a,b){ return Math.random()*(b-a)+a; }
      function confettiBurst(){
        fxBox.innerHTML=""; const COUNT=60;
        for(let i=0;i<COUNT;i++){
          const d=document.createElement('div'); d.className='ce-piece';
          const ang=rand(0,2*Math.PI), dist=rand(120,230);
          d.style.setProperty('--dx', Math.cos(ang)*dist+'px');
          d.style.setProperty('--dy', Math.sin(ang)*dist+'px');
          d.style.setProperty('--rot', rand(180,1080)+'deg');
          d.style.left='50%'; d.style.top='50%';
          const colors=['#ff6b6b','#ffd166','#06d6a0','#4cc9f0','#b5179e','#ffb703'];
          d.style.background=colors[i%colors.length];
          d.style.animation=`ce-burst ${rand(650,1100)}ms ease-out forwards`;
          d.style.animationDelay=rand(0,120)+'ms';
          fxBox.appendChild(d);
        }
      }
      function setVisible(v){
        overlay.classList.toggle('show', v);
        overlay.setAttribute('aria-hidden', v ? 'false' : 'true');
        modal.style.visibility = v ? 'visible' : 'hidden';
        document.documentElement.style.overflow = v ? 'hidden' : '';
        document.body.style.overflow = v ? 'hidden' : '';
        if(v) closeBtn.focus();
      }
      window.ndCelebrate = function(message){
        const list = QUOTES;
        const msg = message || list[Math.floor(Math.random()*list.length)];
        document.getElementById('ceMsg').textContent = msg;
        setVisible(true);
        confettiBurst();
      };
      overlay.addEventListener('click', ()=>setVisible(false));
      closeBtn.addEventListener('click', ()=>setVisible(false));
      window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && overlay.classList.contains('show')) setVisible(false); });
    })();
  </script>

  <!-- Global “celebrate on download” hooks (ALL tools) -->
  <script>
  (function () {
    if (window.__ndDownloadHooked) return;
    window.__ndDownloadHooked = true;

    const QUOTES = [
      "Small steps make big things.",
      "Every page is progress.",
      "Done is better than perfect.",
      "Momentum loves action.",
      "Keep going — you’ve got this!"
    ];
    const pick = () => QUOTES[(Math.random() * QUOTES.length) | 0];

    const origClick = HTMLAnchorElement.prototype.click;
    HTMLAnchorElement.prototype.click = function () {
      const isDownload = this.hasAttribute('download');
      const name = this.getAttribute('download') || 'Your file';
      const ret = origClick.apply(this, arguments);
      if (isDownload && typeof window.ndCelebrate === 'function') {
        setTimeout(() => window.ndCelebrate(`“${name}” is downloading. ${pick()}`), 50);
      }
      return ret;
    };
  })();

  (function patchJsPDFSave() {
    function tryPatch() {
      try {
        if (!window.jspdf?.jsPDF) return false;
        if (window.__ndJsPDFPatched) return true;
        const API = window.jspdf.jsPDF.API;
        if (!API || !API.save) return false;

        const origSave = API.save;
        API.save = function (filename) {
          const res = origSave.apply(this, arguments);
          if (typeof window.ndCelebrate === 'function') {
            setTimeout(() => window.ndCelebrate(`“${filename || 'PDF'}” is downloading. Keep the momentum going!`), 50);
          }
          return res;
        };
        window.__ndJsPDFPatched = true;
        return true;
      } catch { return false; }
    }
    if (!tryPatch()) {
      window.addEventListener('load', tryPatch, { once: true });
      document.addEventListener('readystatechange', tryPatch, { once: true });
    }
  })();
  </script>

  <!-- Camera + UI wiring -->
  <script>
    // Footer year
    document.getElementById('yr').textContent = new Date().getFullYear();

    // Tabs
    function activateTab(name){
      document.querySelectorAll('.tab').forEach(t=>{
        const on = t.dataset.tab===name;
        t.classList.toggle('active', on);
        t.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
      document.querySelectorAll('.tabpanel').forEach(p=>{
        const on = p.dataset.tabpanel===name;
        p.classList.toggle('hidden', !on);
      });
      document.getElementById('main').scrollIntoView({behavior:'smooth', block:'start'});
    }
    document.querySelectorAll('#tabs .tab').forEach(btn=>{
      btn.addEventListener('click', ()=>activateTab(btn.dataset.tab));
    });

    // Search filter
    const searchInput = document.getElementById('toolSearch');
    searchInput.addEventListener('input', e=>{
      const q = e.target.value.trim().toLowerCase();
      document.querySelectorAll('.tool-card').forEach(card=>{
        const text = card.innerText.toLowerCase();
        card.style.display = text.includes(q) ? '' : 'none';
      });
    });

    // Quick-launch
    const idMap = { scan:'tool-scan', images:'tool-images', export:'tool-export', compress:'tool-compress', split:'tool-split' };
    function centerAndHighlight(el){ if(!el) return; el.scrollIntoView({behavior:'smooth', block:'center'}); el.classList.add('pulse'); setTimeout(()=>el.classList.remove('pulse'),1500); }
    document.querySelectorAll('.home-card').forEach(card=>{
      card.addEventListener('click', ()=>{
        const tab = card.dataset.open || 'docs';
        const anchor = card.dataset.anchor || '';
        activateTab(tab);
        if(anchor){ setTimeout(()=>centerAndHighlight(document.getElementById(idMap[anchor])),220); }
      });
    });

    /* ======= Camera module (updated) ======= */
    (function () {
      const $ = (s, root = document) => root.querySelector(s);

      const overlay   = $('#camOverlay');
      const video     = $('#scanVideo');
      const btnOpen   = $('#scanOpen');
      const btnClose  = $('#camClose');
      const btnFlip   = $('#camFlip');
      const btnSnap   = $('#scanSnap');
      const thumbs    = $('#scanThumbs');
      const camTray   = $('#camTray');
      const statusEl  = $('#scanStatus');
      const btnExport = $('#scanExport');

      let stream = null;
      let useBack = true;
      let captured = [];
      let sortable = null;
      let sortableReady = false; // init Sortable once
      let previouslyFocused = null;

      function setStatus(m) {
        if (statusEl) statusEl.textContent = m || '';
      }
      function lockScroll(lock) {
        document.documentElement.style.overflow = lock ? 'hidden' : '';
        document.body.style.overflow = lock ? 'hidden' : '';
      }
      function stopStream() {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          stream = null;
        }
      }
      function setOverlayVisible(v) {
        if (!overlay) return;
        overlay.classList.toggle('show', v);
        overlay.setAttribute('aria-hidden', v ? 'false' : 'true');
        lockScroll(v);
        if (v) {
          previouslyFocused = document.activeElement;
          btnClose?.focus?.();
        } else {
          previouslyFocused?.focus?.();
        }
      }

      async function openCamera() {
        try {
          stopStream();
          setOverlayVisible(true);
          const constraints = {
            audio: false,
            video: {
              facingMode: useBack ? { ideal: 'environment' } : 'user',
              width:  { ideal: 1920 },
              height: { ideal: 1080 }
            }
          };
          stream = await navigator.mediaDevices.getUserMedia(constraints);
          if (video) {
            video.srcObject = stream;
            await video.play().catch(() => {});
          }
          setStatus('');
        } catch (err) {
          setOverlayVisible(false);
          setStatus('Camera error: ' + (err?.message || err));
          console.error(err);
        }
      }
      function closeCamera() {
        setOverlayVisible(false);
        stopStream();
      }

      async function takeSnapshot() {
        if (!video?.videoWidth) return;
        const w = video.videoWidth;
        const h = video.videoHeight;
        const c = document.createElement('canvas');
        c.width = w; c.height = h;
        c.getContext('2d').drawImage(video, 0, 0, w, h);
        const dataUrl = c.toDataURL('image/jpeg', 0.92);
        captured.push({ dataUrl, w, h });
        renderThumbs();
        setStatus(`${captured.length} page${captured.length > 1 ? 's' : ''} ready.`);
      }

      function renderThumbs() {
        // Main grid under the tool card
        if (thumbs) {
          thumbs.innerHTML = '';
          captured.forEach((it, i) => {
            const div = document.createElement('div');
            div.className = 'thumb';
            div.dataset.index = String(i);
            div.innerHTML = `
              <button class="handle" title="Drag" aria-label="Drag to reorder">⋮⋮</button>
              <button class="x" title="Remove" aria-label="Remove page ${i + 1}">×</button>
              <img src="${it.dataUrl}" alt="Captured page ${i + 1}">
            `;
            div.querySelector('.x')?.addEventListener('click', () => {
              captured.splice(i, 1);
              renderThumbs();
              setStatus(captured.length ? `${captured.length} page(s) ready.` : 'No pages.');
            });
            thumbs.appendChild(div);
          });

          // Initialize Sortable only once (avoid destroy/reattach crashes)
          if (!sortableReady && window.Sortable && thumbs.childElementCount) {
            sortable = new Sortable(thumbs, {
              animation: 150,
              handle: '.handle',
              onEnd: (evt) => {
                const [moved] = captured.splice(evt.oldIndex, 1);
                captured.splice(evt.newIndex, 0, moved);
                renderThumbs(); // re-render to refresh indices & buttons
              }
            });
            sortableReady = true;
          }
        }

        // Small horizontal tray inside the camera overlay
        if (camTray) {
          camTray.innerHTML = '';
          captured.forEach((it, i) => {
            const d = document.createElement('div');
            d.className = 'cam-thumb';
            d.innerHTML = `
              <button class="x" aria-label="Remove shot ${i + 1}">×</button>
              <img src="${it.dataUrl}" alt="Shot ${i + 1}">
            `;
            d.querySelector('.x')?.addEventListener('click', () => {
              captured.splice(i, 1);
              renderThumbs();
            });
            camTray.appendChild(d);
          });
        }
      }

      async function ensureJsPDF() {
        if (window.jspdf?.jsPDF) return window.jspdf.jsPDF;
        await new Promise((res, rej) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
          s.defer = true;
          s.crossOrigin = 'anonymous';
          s.onload = res;
          s.onerror = () => rej(new Error('Failed to load jsPDF'));
          document.head.appendChild(s);
        });
        if (!window.jspdf?.jsPDF) throw new Error('jsPDF not available');
        return window.jspdf.jsPDF;
      }

      async function exportPDF() {
        if (!captured.length) { setStatus('Add at least one snapshot.'); return; }
        setStatus('Building PDF…');
        try {
          const jsPDF = await ensureJsPDF();
          const pdf = new jsPDF({ unit: 'pt', format: 'a4', orientation: 'p' });
          const pw = pdf.internal.pageSize.getWidth();
          const ph = pdf.internal.pageSize.getHeight();
          const margin = 24;

          const images = await Promise.all(
            captured.map(p => new Promise((res, rej) => {
              const im = new Image();
              im.onload = () => res(im);
              im.onerror = rej;
              im.src = p.dataUrl;
            }))
          );

          images.forEach((im, i) => {
            if (i > 0) pdf.addPage();
            const sW = im.naturalWidth || im.width;
            const sH = im.naturalHeight || im.height;
            const maxW = pw - margin * 2;
            const maxH = ph - margin * 2;
            const scale = Math.min(maxW / sW, maxH / sH);
            const dW = sW * scale;
            const dH = sH * scale;
            const x = (pw - dW) / 2;
            const y = (ph - dH) / 2;
            pdf.addImage(im, 'JPEG', x, y, dW, dH);
          });

          pdf.save('scan.pdf');
          setStatus('Exported scan.pdf');
          // No manual ndCelebrate here — global hooks show the popup for all downloads.
        } catch (err) {
          console.error(err);
          setStatus('Export failed: ' + (err?.message || err));
        }
      }

      // Events
      btnOpen?.addEventListener('click', openCamera);
      btnClose?.addEventListener('click', closeCamera);
      btnFlip?.addEventListener('click', async () => { useBack = !useBack; await openCamera(); });
      btnSnap?.addEventListener('click', takeSnapshot);
      overlay?.addEventListener('click', e => { if (e.target === overlay) closeCamera(); });
      btnExport?.addEventListener('click', exportPDF);
      window.addEventListener('keydown', e => { if (e.key === 'Escape' && overlay?.classList.contains('show')) { e.preventDefault(); closeCamera(); } });
      window.addEventListener('pagehide', stopStream);
    })();
  </script>

  <!-- Service Worker (subpath-aware) -->
  <script>
    if ('serviceWorker' in navigator) {
      const swUrl = window.__ndPath__('service-worker.js');
      const scope = window.__ndPath__('');
      navigator.serviceWorker.register(swUrl, { scope }).catch(console.error);
    }
  </script>
</body>
</html>
